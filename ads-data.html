<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>4.1&nbsp;Exporting and Restoring data from ApacheDS</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><link rel="stylesheet" type="text/css" href="custom.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--><link rel="shortcut icon" type="image/png" href="https://res.cloudinary.com/kdr2/image/upload/img-kdr2-com/main/k-favicon.png"/><script type="text/x-mathjax-config">MathJax.Hub.Config({
    jax: ["input/TeX","output/HTML-CSS"],
    displayAlign: "left"
})</script></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">He who doesn&rsquo;t blend in</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="preface.html" class="tocviewlink" data-pltdoc="x">Preface</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="whims.html" class="tocviewlink" data-pltdoc="x">Spark, whims!</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="essays.html" class="tocviewlink" data-pltdoc="x">Fly, the unchained!</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="contraptions.html" class="tocviewselflink" data-pltdoc="x">Roll, contraptions!</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="josh.html" class="tocviewlink" data-pltdoc="x">Shine, Josh!</a></td></tr><tr><td align="right">6&nbsp;</td><td><a href="appendices.html" class="tocviewlink" data-pltdoc="x">Appendices</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9660;</a></td><td>4&nbsp;</td><td><a href="contraptions.html" class="tocviewlink" data-pltdoc="x">Roll, contraptions!</a></td></tr></table><div class="tocviewsublistbottom" style="display: block;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">4.1&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Exporting and Restoring data from Apache<span class="mywbr"> &nbsp;</span>DS</a></td></tr><tr><td align="right">4.2&nbsp;</td><td><a href="chrome-svg-blur.html" class="tocviewlink" data-pltdoc="x">Avoid blurry rendering of SVG paths in Chromium</a></td></tr><tr><td align="right">4.3&nbsp;</td><td><a href="howto-de-es-chars.html" class="tocviewlink" data-pltdoc="x">How to
type German and Spanish characters</a></td></tr><tr><td align="right">4.4&nbsp;</td><td><a href="scribble-md.html" class="tocviewlink" data-pltdoc="x">Use Markdown in Scribble</a></td></tr></table></div></div></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="version">8.11</span></div><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;<span class="tocsettoggle">&nbsp;&nbsp;<a href="javascript:void(0);" title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span></span><span class="navright">&nbsp;&nbsp;<a href="contraptions.html" title="backward to &quot;4 Roll, contraptions!&quot;" data-pltdoc="x" rel="prev">&larr; prev</a>&nbsp;&nbsp;<a href="contraptions.html" title="up to &quot;4 Roll, contraptions!&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="chrome-svg-blur.html" title="forward to &quot;4.2 Avoid blurry rendering of SVG paths in Chromium&quot;" data-pltdoc="x" rel="next">next &rarr;</a></span>&nbsp;</div><h4>4.1<tt>&nbsp;</tt><a name="(part._ads-data)"></a>Exporting and Restoring data from ApacheDS</h4><blockquote class="refpara"><blockquote class="refcolumn"><blockquote class="refcontent"><p>2018-12-25</p></blockquote></blockquote></blockquote><p>I am using <a href="http://directory.apache.org/apacheds/">ApacheDS</a> as the LDAP server and find I should export the data
out from it or restore the exported data into it under some
circumstances:</p><ul><li><p>When the data is corrupted thus while we are able to read the
data but we can&rsquo;t write new data into it.</p></li><li><p>When we want to back up the data and possibly restore it in the
future.</p></li></ul><p>Though <a href="http://directory.apache.org/apacheds/">ApacheDS</a> provides a desktop application based on Eclipse RCP, the
<a href="https://directory.apache.org/studio/">Apache Directory Studio</a>, to manage the <a href="http://directory.apache.org/apacheds/">ApacheDS</a> server and the data in it, it doesn&rsquo;t
provide a tool to do this automatically. So we could resort to the
commands in the <code class="inline-code">ldap-utils</code> package. This package offers many
commands to interact with a LDAP server, includes:</p><ul><li><p>ldapadd</p></li><li><p>ldapcompare</p></li><li><p>ldapdelete</p></li><li><p>ldapexop</p></li><li><p>ldapmodify</p></li><li><p>ldapmodrdn</p></li><li><p>ldappasswd</p></li><li><p>ldapsearch</p></li><li><p>ldapurl</p></li><li><p>ldapwhoami</p></li></ul><p>To resolve our problems, we can use <code class="inline-code">ldapsearch</code> to export the data,
and <code class="inline-code">ldapadd</code> to restore the data.</p><p>To export the data, it is quite straightforward:</p><p><pre class="code-block">
ldapsearch -LLL -h localhost -p 10389\
           -D "uid=admin,ou=system" -w secrete \
           -b "dc=example,dc=com" -s sub "(ObjectClass=*)" &gt;data.ldif</pre></p><p>With <code class="inline-code">-LLL</code> we tell <code class="inline-code">ldapsearch</code> to display data in the
LDIF(LDAP Data Interchange Format) format, then we give the host and
port of the server, the bind DN and the password of the user, the
search base and the search scope, and finally an attribute filter
which will match all the nodes to the command. To store the exported
data, we redirect the stdout of the command to a file at the end of
the command.</p><p>The data is now successfully exported, but before talking about how to
restore it, let&rsquo;s recall what we did while setting up the <a href="http://directory.apache.org/apacheds/">ApacheDS</a> server:</p><ol><li><p>Download it, unzip it, start it.</p></li><li><p>Create a partition, using <a href="https://directory.apache.org/studio/">Apache Directory Studio</a> is the easiest way to do
it.</p></li><li><p>Restart the server to make the new partition ready.</p></li><li><p>Update the system settings of the server if needed.</p></li><li><p>Create our own schema(commonly, attribute types and object
classes).</p></li></ol><p>Before restoring the exported data, we should set up a new server
instance by these steps first. Then we can do the restoring using
<code class="inline-code">ladpadd</code> like this:</p><p><pre class="code-block">ldapadd -h 127.0.0.1 -p 10389 \
        -D "uid=admin,ou=system" -w secret \
        -f /path/to/data.ldif -c</pre></p><p>But many errors will be encountered while running this command. Inside
the <a href="http://directory.apache.org/apacheds/">ApacheDS</a> server, the data is organized as trees. So a parent node must
be specified while creating a new node. This requires that the parent
node of a certain node must have been restored while it is going to be
restored. On the other hand, the command <code class="inline-code">ldapadd</code> adds new nodes
in the order of how the nodes are stored in the LDIF file, and the
parent-fist order is not guaranteed by <code class="inline-code">ldapsearch</code>. So errors
happen when <code class="inline-code">ldapadd</code> creates nodes whose parent are not created
yet.</p><p>There are two ways to resolve this problem:</p><p>The first one is crude: We run the <code class="inline-code">ldapadd</code> command multiple
times with the option <code class="inline-code">-c</code>.</p><p>The <code class="inline-code">-c</code> option makes <code class="inline-code">ldapadd</code> run in a continuous
operation mode, when an error occurs, <code class="inline-code">ldapadd</code> reports the error
and goes on with its work instead of exiting. Here the errors include
ones like "parent node does not exist", "node already exists", and
many other kinds of errors.</p><p>The count of the times is determined by the maximum depth of the data
tree in the <a href="http://directory.apache.org/apacheds/">ApacheDS</a> server. For example, if our data has a max-depth
3, we should run the command 3 times. During the first time, all nodes
with depth 1 and a few other nodes will be restored. Then the node
with depth 2 and then 3. Finally, all the nodes will be restored.</p><p>The second one is a little more elegant than the first one, but still
simple: we first sort the exported data, then import it. Here is a
perl script to sort the data in the LDIF file:</p><p><pre class="code-block">#!/usr/bin/env perl

use v5.12;
use MIME::Base64;

my $all_nodes = {};
my $all_dn =[];
my $current_node = "";
my $current_dn = "";
my $dn_just_assigned = 0;

while(&lt;&gt;) {
    $current_node .= $_;
    if(m/^\s+$/) {
        $all_nodes-&gt;{$current_dn} = $current_node;
        push @$all_dn, $current_dn;
        $current_node = "";
        $current_dn = "";
        next;
    }
    if(m/^dn::?\s(.*)$/) {
        $current_dn = $1;
        $dn_just_assigned = 1;
        next;
    }
    if($dn_just_assigned) {
        $current_dn .= $1 if(m/^\s+(.+)/);
        $current_dn = decode_base64($current_dn) if index($current_dn, ",") &lt; 0;
        $dn_just_assigned = 0;
    }
}

$all_dn = [sort {length $a &lt;=&gt; length $b} @$all_dn];
print $all_nodes-&gt;{$_} foreach(@$all_dn);
</pre></p><p>Save it as <code class="inline-code">ldap-data-sorter.pl</code> and run it:</p><p><pre class="code-block">ldap-data-sorter.pl /path/to/data.ldif &gt; data-sorted.ldif</pre></p><p>Then restore the data by running the below command for only once:</p><p><pre class="code-block">ldapadd -h 127.0.0.1 -p 10389 \
        -D "uid=admin,ou=system" -w secret \
        -f /path/to/data-sorted.ldif -c</pre></p><p>If all goes well, you will have got what you want at this point.</p><p>Good luck with <a href="http://directory.apache.org/apacheds/">ApacheDS</a> and <a href="https://directory.apache.org/studio/">Apache Directory Studio</a> .</p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;<span class="tocsettoggle">&nbsp;&nbsp;<a href="javascript:void(0);" title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span></span><span class="navright">&nbsp;&nbsp;<a href="contraptions.html" title="backward to &quot;4 Roll, contraptions!&quot;" data-pltdoc="x" rel="prev">&larr; prev</a>&nbsp;&nbsp;<a href="contraptions.html" title="up to &quot;4 Roll, contraptions!&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="chrome-svg-blur.html" title="forward to &quot;4.2 Avoid blurry rendering of SVG paths in Chromium&quot;" data-pltdoc="x" rel="next">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>